<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{.title}} - ExpenseTracker</title>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Styles -->
    <link rel="stylesheet" href="/static/css/swiss-design.css">
    
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/lucide/0.263.1/lucide.min.css">
    
    <style>
        /* Page-specific styles */
        .event-header {
            background: linear-gradient(135deg, #fafafa 0%, #f5f5f5 100%);
            border-bottom: 1px solid var(--color-gray-200);
            position: relative;
        }
        
        .event-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 60 60"><defs><pattern id="grid" width="60" height="60" patternUnits="userSpaceOnUse"><path d="M 60 0 L 0 0 0 60" fill="none" stroke="rgba(0,0,0,0.02)" stroke-width="1"/></pattern></defs><rect width="60" height="60" fill="url(%23grid)"/></svg>');
        }
        
        .action-tabs {
            display: flex;
            gap: 0;
            background: var(--color-white);
            border: 1px solid var(--color-gray-200);
            border-radius: var(--border-radius-lg);
            overflow: hidden;
            box-shadow: var(--shadow-sm);
        }
        
        .action-tab {
            flex: 1;
            padding: var(--space-4) var(--space-6);
            background: transparent;
            border: none;
            color: var(--color-gray-600);
            font-size: var(--text-sm);
            font-weight: 500;
            cursor: pointer;
            transition: all var(--transition-fast);
            position: relative;
            min-height: 56px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-2);
        }
        
        .action-tab:not(:last-child) {
            border-right: 1px solid var(--color-gray-200);
        }
        
        .action-tab:hover {
            background: var(--color-gray-50);
            color: var(--color-black);
        }
        
        .action-tab.active {
            background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-light) 100%);
            color: var(--color-white);
            box-shadow: 0 4px 14px 0 rgba(59, 130, 246, 0.2);
        }
        
        .action-tab.active:hover {
            background: linear-gradient(135deg, #2563eb 0%, var(--color-primary) 100%);
        }
        
        .content-section {
            min-height: 400px;
            animation: fadeIn var(--transition-base) ease-out;
        }
        
        .expense-item {
            padding: var(--space-6);
            border-bottom: 1px solid var(--color-gray-100);
            transition: all var(--transition-fast);
            cursor: pointer;
            position: relative;
        }
        
        .expense-item:last-child {
            border-bottom: none;
        }
        
        .expense-item:hover {
            background: var(--color-gray-50);
            transform: translateX(4px);
        }
        
        .expense-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 3px;
            background: var(--color-gray-300);
            border-radius: 0 var(--border-radius) var(--border-radius) 0;
            transition: all var(--transition-fast);
        }
        
        .expense-item:hover::before {
            background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-light) 100%);
            width: 5px;
        }
        
        .expense-item.pending::before {
            background: var(--color-warning);
        }
        
        .expense-item.approved::before {
            background: var(--color-success);
        }
        
        .expense-item.rejected::before {
            background: var(--color-error);
        }
        
        .balance-card {
            position: relative;
            overflow: hidden;
        }
        
        .balance-card.positive {
            border-left: 4px solid var(--color-success);
            border-top-left-radius: var(--border-radius-lg);
            border-bottom-left-radius: var(--border-radius-lg);
        }
        
        .balance-card.negative {
            border-left: 4px solid var(--color-error);
            border-top-left-radius: var(--border-radius-lg);
            border-bottom-left-radius: var(--border-radius-lg);
        }
        
        .balance-card.neutral {
            border-left: 4px solid var(--color-gray-300);
            border-top-left-radius: var(--border-radius-lg);
            border-bottom-left-radius: var(--border-radius-lg);
        }
        
        .settlement-item {
            padding: var(--space-6);
            border-bottom: 1px solid var(--color-gray-100);
            transition: all var(--transition-fast);
            position: relative;
        }
        
        .settlement-item:last-child {
            border-bottom: none;
        }
        
        .settlement-arrow {
            display: flex;
            align-items: center;
            gap: var(--space-4);
            margin: var(--space-4) 0;
        }
        
        .settlement-arrow::before {
            content: '';
            flex: 1;
            height: 2px;
            background: linear-gradient(to right, var(--color-error), var(--color-success));
            border-radius: 1px;
        }
        
        .form-modal .modal-container {
            max-width: 600px;
        }
        
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: var(--space-4);
            backdrop-filter: blur(4px);
        }
        
        .modal-container {
            background: var(--color-white);
            border-radius: var(--border-radius-xl);
            box-shadow: var(--shadow-lg);
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow: hidden;
            animation: modalEnter 0.3s ease-out;
        }
        
        @keyframes modalEnter {
            from {
                opacity: 0;
                transform: scale(0.95) translateY(20px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }
        
        .modal-header {
            padding: var(--space-6);
            border-bottom: var(--border-width) solid var(--color-gray-200);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .modal-body {
            padding: var(--space-6);
            max-height: 60vh;
            overflow-y: auto;
        }
        
        .modal-footer {
            padding: var(--space-6);
            border-top: var(--border-width) solid var(--color-gray-200);
            display: flex;
            gap: var(--space-3);
            justify-content: flex-end;
        }
        
        .loading-state {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: var(--space-24);
            color: var(--color-gray-500);
        }
        
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: var(--space-24);
            text-align: center;
        }
        
        .empty-state-icon {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, var(--color-gray-100) 0%, var(--color-gray-50) 100%);
            border-radius: var(--border-radius-2xl);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: var(--space-6);
            box-shadow: var(--shadow-sm);
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="nav">
        <div class="nav-container">
            <a href="/dashboard" class="nav-brand">
                <div class="nav-logo">
                    <i data-lucide="receipt"></i>
                </div>
                ExpenseTracker
            </a>
            
            <div class="nav-actions">
                <button class="btn btn-ghost btn-sm" onclick="copyEventCode()">
                    <i data-lucide="copy"></i>
                    Share Event
                </button>
                <div class="nav-user">
                    <div class="user-avatar">
                        <i data-lucide="user"></i>
                    </div>
                    <span id="user-name" class="body-small">Loading...</span>
                </div>
                <button id="logout-btn" class="btn btn-ghost btn-sm">
                    <i data-lucide="log-out"></i>
                    Logout
                </button>
            </div>
        </div>
    </nav>

    <!-- Event Header -->
    <section class="event-header section-sm">
        <div class="container">
            <div class="flex items-center gap-4 mb-6">
                <button class="btn btn-ghost btn-sm" onclick="window.location.href='/dashboard'">
                    <i data-lucide="arrow-left"></i>
                    Back to Dashboard
                </button>
            </div>
            
            <div class="grid grid-3 gap-8" style="align-items: start;">
                <div style="grid-column: span 2;">
                    <h1 id="event-name" class="heading-2 mb-2">Loading...</h1>
                    <p id="event-description" class="body-large opacity-80 mb-6">Loading event details...</p>
                    
                    <div class="flex items-center gap-6">
                        <div class="flex items-center gap-2">
                            <i data-lucide="calendar" class="w-4 h-4 opacity-60"></i>
                            <span id="event-date" class="body-small opacity-80">—</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <i data-lucide="users" class="w-4 h-4 opacity-60"></i>
                            <span id="participant-count" class="body-small opacity-80">— participants</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <i data-lucide="tag" class="w-4 h-4 opacity-60"></i>
                            <span id="event-code" class="body-small opacity-80 font-mono">—</span>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-body text-center">
                        <div class="heading-4 mb-1" id="total-expenses">$0.00</div>
                        <div class="body-small opacity-60">Total Expenses</div>
                        <div class="mt-4">
                            <span id="event-status" class="status-badge status-pending">Loading</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Action Tabs -->
    <section class="section-sm" style="padding-top: var(--space-8);">
        <div class="container">
            <div class="action-tabs mb-8">
                <button class="action-tab active" data-tab="expenses" onclick="switchTab('expenses')">
                    <i data-lucide="receipt"></i>
                    Expenses
                </button>
                <button class="action-tab" data-tab="balances" onclick="switchTab('balances')">
                    <i data-lucide="balance-scale"></i>
                    Balances
                </button>
                <button class="action-tab" data-tab="settlements" onclick="switchTab('settlements')">
                    <i data-lucide="handshake"></i>
                    Settlements
                </button>
                <button class="action-tab" data-tab="participants" onclick="switchTab('participants')">
                    <i data-lucide="users"></i>
                    People
                </button>
            </div>
        </div>
    </section>

    <!-- Content Sections -->
    <section class="section" style="padding-top: 0;">
        <div class="container">
            <!-- Expenses Tab -->
            <div id="expenses-content" class="content-section">
                <div class="flex justify-between items-center mb-8">
                    <h2 class="heading-3">Expenses</h2>
                    <div class="flex gap-3">
                        <button class="btn btn-secondary" onclick="showAddContributionModal()">
                            <i data-lucide="plus-circle"></i>
                            Add Contribution
                        </button>
                        <button class="btn btn-primary" onclick="showAddExpenseModal()">
                            <i data-lucide="receipt"></i>
                            Add Expense
                        </button>
                    </div>
                </div>
                
                <div class="card">
                    <div id="expenses-list">
                        <div class="loading-state">
                            <i data-lucide="loader-2" class="animate-spin mr-2"></i>
                            Loading expenses...
                        </div>
                    </div>
                </div>
            </div>

            <!-- Balances Tab -->
            <div id="balances-content" class="content-section" style="display: none;">
                <div class="flex justify-between items-center mb-8">
                    <h2 class="heading-3">Current Balances</h2>
                    <button class="btn btn-ghost" onclick="refreshBalances()">
                        <i data-lucide="refresh-cw"></i>
                        Refresh
                    </button>
                </div>
                
                <div id="balances-grid" class="grid grid-auto gap-4">
                    <div class="loading-state">
                        <i data-lucide="loader-2" class="animate-spin mr-2"></i>
                        Calculating balances...
                    </div>
                </div>
            </div>

            <!-- Settlements Tab -->
            <div id="settlements-content" class="content-section" style="display: none;">
                <div class="flex justify-between items-center mb-8">
                    <h2 class="heading-3">Settlements</h2>
                    <button class="btn btn-primary" onclick="generateSettlements()">
                        <i data-lucide="zap"></i>
                        Generate Settlements
                    </button>
                </div>
                
                <div class="card">
                    <div id="settlements-list">
                        <div class="loading-state">
                            <i data-lucide="loader-2" class="animate-spin mr-2"></i>
                            Loading settlements...
                        </div>
                    </div>
                </div>
            </div>

            <!-- Participants Tab -->
            <div id="participants-content" class="content-section" style="display: none;">
                <div class="flex justify-between items-center mb-8">
                    <h2 class="heading-3">Participants</h2>
                    <button class="btn btn-secondary" onclick="copyEventCode()">
                        <i data-lucide="user-plus"></i>
                        Invite People
                    </button>
                </div>
                
                <div class="grid grid-auto gap-4" id="participants-grid">
                    <div class="loading-state">
                        <i data-lucide="loader-2" class="animate-spin mr-2"></i>
                        Loading participants...
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Add Expense Modal -->
    <div id="add-expense-modal" class="modal-overlay form-modal" style="display: none;">
        <div class="modal-container">
            <div class="modal-header">
                <h3 class="heading-4">Add Expense</h3>
                <button class="btn btn-ghost btn-sm" onclick="closeModal('add-expense-modal')">
                    <i data-lucide="x"></i>
                </button>
            </div>
            
            <form id="add-expense-form" class="modal-body">
                <div class="form-group">
                    <label class="form-label" for="expense-description">Description</label>
                    <input type="text" id="expense-description" class="form-input" placeholder="e.g., Dinner at Restaurant" required>
                </div>
                
                <div class="grid grid-2 gap-4">
                    <div class="form-group">
                        <label class="form-label" for="expense-amount">Amount</label>
                        <input type="number" id="expense-amount" class="form-input" step="0.01" min="0.01" placeholder="0.00" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="expense-category">Category</label>
                        <select id="expense-category" class="form-select" required>
                            <option value="">Select category</option>
                            <option value="1">🍽️ Food & Dining</option>
                            <option value="2">🚗 Transportation</option>
                            <option value="3">🏨 Accommodation</option>
                            <option value="4">🎬 Entertainment</option>
                            <option value="5">🛍️ Shopping</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="expense-date">Date</label>
                    <input type="date" id="expense-date" class="form-input" required>
                </div>
            </form>
            
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('add-expense-modal')">Cancel</button>
                <button type="submit" form="add-expense-form" class="btn btn-primary">Add Expense</button>
            </div>
        </div>
    </div>

    <!-- Add Contribution Modal -->
    <div id="add-contribution-modal" class="modal-overlay form-modal" style="display: none;">
        <div class="modal-container">
            <div class="modal-header">
                <h3 class="heading-4">Add Contribution</h3>
                <button class="btn btn-ghost btn-sm" onclick="closeModal('add-contribution-modal')">
                    <i data-lucide="x"></i>
                </button>
            </div>
            
            <form id="add-contribution-form" class="modal-body">
                <div class="form-group">
                    <label class="form-label" for="contribution-amount">Amount</label>
                    <input type="number" id="contribution-amount" class="form-input" step="0.01" min="0.01" placeholder="0.00" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="contribution-notes">Notes (Optional)</label>
                    <textarea id="contribution-notes" class="form-input" rows="3" placeholder="Any additional notes about this contribution..."></textarea>
                </div>
            </form>
            
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('add-contribution-modal')">Cancel</button>
                <button type="submit" form="add-contribution-form" class="btn btn-success">Add Contribution</button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script src="/static/js/utils.js"></script>
    <script>
        // Initialize Lucide icons
        lucide.createIcons();
        
        // Global state
        const currentEventId = new URLSearchParams(window.location.search).get('id') || '1';
        let currentEvent = null;
        let currentUser = null;
        let expenses = [];
        let balances = [];
        let settlements = [];
        let participants = [];
        
        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            initializeEventDetails();
        });
        
        async function initializeEventDetails() {
            try {
                // Load user profile
                await loadUserProfile();
                
                // Load event data
                await Promise.all([
                    loadEventDetails(),
                    loadExpenses(),
                    loadBalances(),
                    loadSettlements(),
                    loadParticipants()
                ]);
                
                // Set up event listeners
                setupEventListeners();
                
                // Set today's date as default
                document.getElementById('expense-date').value = new Date().toISOString().split('T')[0];
                
            } catch (error) {
                console.error('Failed to initialize event details:', error);
                showErrorMessage('Failed to load event data');
            }
        }
        
        async function loadUserProfile() {
            try {
                const response = await apiCall('/api/v1/auth/profile');
                if (response.ok) {
                    currentUser = await response.json();
                    document.getElementById('user-name').textContent = currentUser.display_name || currentUser.username;
                }
            } catch (error) {
                console.error('Failed to load user profile:', error);
            }
        }
        
        async function loadEventDetails() {
            try {
                const response = await apiCall(`/api/v1/events/${currentEventId}`);
                if (response.ok) {
                    currentEvent = await response.json();
                    
                    // Update UI
                    document.getElementById('event-name').textContent = currentEvent.name;
                    document.getElementById('event-description').textContent = currentEvent.description || 'No description provided';
                    document.getElementById('event-date').textContent = new Date(currentEvent.created_at).toLocaleDateString();
                    document.getElementById('participant-count').textContent = `${currentEvent.participant_count || 0} participants`;
                    document.getElementById('event-code').textContent = currentEvent.code;
                    document.getElementById('total-expenses').textContent = `$${(currentEvent.total_expenses || 0).toFixed(2)}`;
                    
                    // Update status
                    const statusEl = document.getElementById('event-status');
                    statusEl.textContent = currentEvent.status;
                    statusEl.className = `status-badge status-${currentEvent.status}`;
                    
                    // Update page title
                    document.title = `${currentEvent.name} - ExpenseTracker`;
                }
            } catch (error) {
                console.error('Failed to load event details:', error);
            }
        }
        
        async function loadExpenses() {
            try {
                const response = await apiCall(`/api/v1/expenses/event/${currentEventId}/`);
                if (response.ok) {
                    expenses = await response.json();
                    renderExpenses();
                }
            } catch (error) {
                console.error('Failed to load expenses:', error);
                document.getElementById('expenses-list').innerHTML = 
                    '<div class="empty-state"><p class="body-base text-red-600">Failed to load expenses</p></div>';
            }
        }
        
        function renderExpenses() {
            const container = document.getElementById('expenses-list');
            
            if (expenses.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">
                            <i data-lucide="receipt" style="width: 32px; height: 32px; color: var(--color-gray-400);"></i>
                        </div>
                        <h3 class="heading-4 mb-2">No expenses yet</h3>
                        <p class="body-base opacity-80 mb-6">Start by adding your first expense to this event.</p>
                        <button class="btn btn-primary" onclick="showAddExpenseModal()">
                            <i data-lucide="plus"></i>
                            Add First Expense
                        </button>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = expenses.map(expense => {
                const categoryEmojis = {
                    1: '🍽️',
                    2: '🚗', 
                    3: '🏨',
                    4: '🎬',
                    5: '🛍️'
                };
                
                return `
                    <div class="expense-item ${expense.status}" onclick="showExpenseDetails(${expense.id})">
                        <div class="flex justify-between items-start">
                            <div class="flex gap-4">
                                <div class="text-2xl">${categoryEmojis[expense.category_id] || '📝'}</div>
                                <div>
                                    <h4 class="heading-5 mb-1">${expense.description}</h4>
                                    <p class="body-small opacity-60">
                                        by ${expense.submitter?.display_name || expense.submitter?.username || 'Unknown'} • 
                                        ${new Date(expense.date).toLocaleDateString()}
                                    </p>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="heading-5">$${parseFloat(expense.amount).toFixed(2)}</div>
                                <span class="status-badge status-${expense.status}">${expense.status}</span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Re-initialize icons
            lucide.createIcons();
        }
        
        async function loadBalances() {
            try {
                const response = await apiCall(`/api/v1/settlements/event/${currentEventId}/balances`);
                if (response.ok) {
                    balances = await response.json();
                    renderBalances();
                }
            } catch (error) {
                console.error('Failed to load balances:', error);
            }
        }
        
        function renderBalances() {
            const container = document.getElementById('balances-grid');
            
            if (balances.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">
                            <i data-lucide="balance-scale" style="width: 32px; height: 32px; color: var(--color-gray-400);"></i>
                        </div>
                        <h3 class="heading-4 mb-2">No balance data</h3>
                        <p class="body-base opacity-80">Add some expenses to see balance calculations.</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = balances.map(balance => {
                const netBalance = parseFloat(balance.net_balance || 0);
                const balanceType = netBalance > 0 ? 'positive' : netBalance < 0 ? 'negative' : 'neutral';
                
                return `
                    <div class="balance-card card ${balanceType}">
                        <div class="card-body">
                            <div class="flex items-center gap-3 mb-4">
                                <div class="user-avatar">
                                    <i data-lucide="user"></i>
                                </div>
                                <div>
                                    <h4 class="heading-5">${balance.display_name || balance.username}</h4>
                                    <p class="body-small opacity-60">${balance.role || 'Participant'}</p>
                                </div>
                            </div>
                            
                            <div class="grid grid-2 gap-4 mb-4">
                                <div>
                                    <div class="body-small opacity-60">Contributed</div>
                                    <div class="body-base font-medium">$${parseFloat(balance.contributed || 0).toFixed(2)}</div>
                                </div>
                                <div>
                                    <div class="body-small opacity-60">Spent</div>
                                    <div class="body-base font-medium">$${parseFloat(balance.spent || 0).toFixed(2)}</div>
                                </div>
                            </div>
                            
                            <div class="text-center">
                                <div class="heading-4 ${netBalance >= 0 ? 'text-green-600' : 'text-red-600'}">
                                    ${netBalance >= 0 ? '+' : ''}$${netBalance.toFixed(2)}
                                </div>
                                <div class="body-small opacity-60">
                                    ${netBalance > 0 ? 'Gets back' : netBalance < 0 ? 'Owes' : 'Even'}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Re-initialize icons
            lucide.createIcons();
        }
        
        async function loadSettlements() {
            console.log('DEBUG: Loading settlements for eventID:', currentEventId);
            try {
                const response = await apiCall(`/api/v1/settlements/event/${currentEventId}/`);
                console.log('DEBUG: Settlements response status:', response.status);
                
                if (response.ok) {
                    settlements = await response.json();
                    console.log('DEBUG: Retrieved settlements:', settlements);
                    renderSettlements();
                } else {
                    const error = await response.json();
                    console.log('DEBUG: Settlements error:', error);
                }
            } catch (error) {
                console.error('Failed to load settlements:', error);
            }
        }
        
        function renderSettlements() {
            const container = document.getElementById('settlements-list');
            
            if (settlements.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">
                            <i data-lucide="handshake" style="width: 32px; height: 32px; color: var(--color-gray-400);"></i>
                        </div>
                        <h3 class="heading-4 mb-2">No settlements yet</h3>
                        <p class="body-base opacity-80 mb-6">Generate settlements to see who owes whom.</p>
                        <button class="btn btn-primary" onclick="generateSettlements()">
                            <i data-lucide="zap"></i>
                            Generate Settlements
                        </button>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = settlements.map(settlement => `
                <div class="settlement-item">
                    <div class="flex justify-between items-center">
                        <div class="settlement-arrow">
                            <div class="flex items-center gap-3">
                                <div class="user-avatar">
                                    <i data-lucide="user"></i>
                                </div>
                                <div>
                                    <div class="body-base font-medium text-red-600">
                                        ${settlement.from_user?.display_name || settlement.from_user?.username || 'Unknown'}
                                    </div>
                                    <div class="body-small opacity-60">Pays</div>
                                </div>
                            </div>
                            
                            <div class="flex items-center gap-3">
                                <div class="user-avatar">
                                    <i data-lucide="user"></i>
                                </div>
                                <div>
                                    <div class="body-base font-medium text-green-600">
                                        ${settlement.to_user?.display_name || settlement.to_user?.username || 'Unknown'}
                                    </div>
                                    <div class="body-small opacity-60">Receives</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="text-right">
                            <div class="heading-4">$${parseFloat(settlement.amount).toFixed(2)}</div>
                            <span class="status-badge status-${settlement.status}">${settlement.status}</span>
                        </div>
                    </div>
                </div>
            `).join('');
            
            // Re-initialize icons
            lucide.createIcons();
        }
        
        async function loadParticipants() {
            try {
                // This would typically be a separate endpoint
                // For now, we'll extract from event details
                participants = []; // Placeholder
                renderParticipants();
            } catch (error) {
                console.error('Failed to load participants:', error);
            }
        }
        
        function renderParticipants() {
            const container = document.getElementById('participants-grid');
            container.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">
                        <i data-lucide="users" style="width: 32px; height: 32px; color: var(--color-gray-400);"></i>
                    </div>
                    <h3 class="heading-4 mb-2">Participants</h3>
                    <p class="body-base opacity-80">Participant management coming soon.</p>
                </div>
            `;
        }
        
        // Tab switching
        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.action-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
            
            // Update content sections
            document.querySelectorAll('.content-section').forEach(section => {
                section.style.display = 'none';
            });
            document.getElementById(`${tabName}-content`).style.display = 'block';
            
            // Re-initialize icons for the visible section
            lucide.createIcons();
        }
        
        // Modal functions
        function showAddExpenseModal() {
            document.getElementById('add-expense-modal').style.display = 'flex';
            document.getElementById('expense-description').focus();
        }
        
        function showAddContributionModal() {
            document.getElementById('add-contribution-modal').style.display = 'flex';
            document.getElementById('contribution-amount').focus();
        }
        
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }
        
        // Event handlers
        function setupEventListeners() {
            // Logout button
            document.getElementById('logout-btn').addEventListener('click', logout);
            
            // Form submissions
            document.getElementById('add-expense-form').addEventListener('submit', handleAddExpense);
            document.getElementById('add-contribution-form').addEventListener('submit', handleAddContribution);
            
            // Modal close on overlay click
            document.querySelectorAll('.modal-overlay').forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.style.display = 'none';
                    }
                });
            });
        }
        
        async function handleAddExpense(e) {
            e.preventDefault();
            
            const expenseData = {
                description: document.getElementById('expense-description').value,
                amount: parseFloat(document.getElementById('expense-amount').value),
                currency: currentEvent?.currency || 'USD',
                category_id: parseInt(document.getElementById('expense-category').value),
                date: document.getElementById('expense-date').value + 'T00:00:00Z',
                split_type: 'equal',
                participants: []
            };
            
            try {
                const response = await apiCall(`/api/v1/expenses/event/${currentEventId}/`, {
                    method: 'POST',
                    body: JSON.stringify(expenseData)
                });
                
                if (response.ok) {
                    closeModal('add-expense-modal');
                    showSuccessMessage('Expense added successfully!');
                    
                    // Refresh data
                    await Promise.all([
                        loadExpenses(),
                        loadEventDetails(),
                        loadBalances()
                    ]);
                    
                    // Reset form
                    document.getElementById('add-expense-form').reset();
                    document.getElementById('expense-date').value = new Date().toISOString().split('T')[0];
                } else {
                    const error = await response.json();
                    showErrorMessage(error.error || 'Failed to add expense');
                }
            } catch (error) {
                console.error('Error adding expense:', error);
                showErrorMessage('Failed to add expense');
            }
        }
        
        async function handleAddContribution(e) {
            e.preventDefault();
            
            const contributionData = {
                amount: parseFloat(document.getElementById('contribution-amount').value),
                currency: currentEvent?.currency || 'USD',
                notes: document.getElementById('contribution-notes').value
            };
            
            try {
                const response = await apiCall(`/api/v1/events/${currentEventId}/contributions`, {
                    method: 'POST',
                    body: JSON.stringify(contributionData)
                });
                
                if (response.ok) {
                    closeModal('add-contribution-modal');
                    showSuccessMessage('Contribution added successfully!');
                    
                    // Refresh data
                    await Promise.all([
                        loadEventDetails(),
                        loadBalances()
                    ]);
                    
                    // Reset form
                    document.getElementById('add-contribution-form').reset();
                } else {
                    const error = await response.json();
                    showErrorMessage(error.error || 'Failed to add contribution');
                }
            } catch (error) {
                console.error('Error adding contribution:', error);
                showErrorMessage('Failed to add contribution');
            }
        }
        
        async function generateSettlements() {
            console.log('DEBUG: Generating settlements for eventID:', currentEventId);
            
            try {
                const response = await apiCall(`/api/v1/settlements/event/${currentEventId}/generate`, {
                    method: 'POST'
                });
                
                console.log('DEBUG: Generate settlements response status:', response.status);
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('DEBUG: Generate settlements success:', result);
                    showSuccessMessage('Settlements generated successfully!');
                    
                    // Switch to settlements tab
                    switchTab('settlements');
                    
                    // Refresh settlements
                    await loadSettlements();
                } else {
                    const error = await response.json();
                    console.log('DEBUG: Generate settlements error:', error);
                    showErrorMessage(error.error || 'Failed to generate settlements');
                }
            } catch (error) {
                console.error('DEBUG: Generate settlements exception:', error);
                showErrorMessage('Failed to generate settlements');
            }
        }
        
        async function refreshBalances() {
            await loadBalances();
            showSuccessMessage('Balances refreshed');
        }
        
        function copyEventCode() {
            if (currentEvent?.code) {
                navigator.clipboard.writeText(currentEvent.code).then(() => {
                    showSuccessMessage(`Event code ${currentEvent.code} copied to clipboard!`);
                });
            }
        }
        
        function showExpenseDetails(expenseId) {
            // This would typically open a detailed view
            console.log('Show expense details for ID:', expenseId);
        }
        
        function logout() {
            localStorage.removeItem('token');
            window.location.href = '/';
        }
        
        // Utility functions
        function showSuccessMessage(message) {
            const toast = document.createElement('div');
            toast.className = 'fixed top-4 right-4 bg-green-500 text-white p-4 rounded-lg shadow-lg z-50 flex items-center gap-2';
            toast.innerHTML = `<i data-lucide="check-circle"></i> ${message}`;
            document.body.appendChild(toast);
            
            lucide.createIcons();
            
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }
        
        function showErrorMessage(message) {
            const toast = document.createElement('div');
            toast.className = 'fixed top-4 right-4 bg-red-500 text-white p-4 rounded-lg shadow-lg z-50 flex items-center gap-2';
            toast.innerHTML = `<i data-lucide="alert-circle"></i> ${message}`;
            document.body.appendChild(toast);
            
            lucide.createIcons();
            
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }
        
        // API helper
        async function apiCall(url, options = {}) {
            const token = localStorage.getItem('token');
            const defaultOptions = {
                headers: {
                    'Content-Type': 'application/json',
                    ...(token && { 'Authorization': `Bearer ${token}` }),
                    ...options.headers
                }
            };
            
            return fetch(url, { ...defaultOptions, ...options });
        }
    </script>
</body>
</html>
