<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Event Details - ExpenseTracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Navigation Header -->
    <nav class="bg-white border-b border-gray-200 sticky top-0 z-30">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center space-x-4">
                    <button onclick="window.history.back()" class="text-gray-600 hover:text-gray-900">
                        <i class="fas fa-arrow-left text-lg"></i>
                    </button>
                    <div class="h-8 w-8 bg-blue-600 rounded-lg flex items-center justify-center">
                        <i class="fas fa-receipt text-white text-sm"></i>
                    </div>
                    <h1 class="text-xl font-bold text-gray-900" id="event-name">Event Details</h1>
                </div>
                
                <div class="flex items-center space-x-4">
                    <div class="flex items-center space-x-3">
                        <div class="h-8 w-8 bg-gray-300 rounded-full flex items-center justify-center">
                            <i class="fas fa-user text-gray-600 text-sm"></i>
                        </div>
                        <span id="user-name" class="text-sm font-medium text-gray-700">Loading...</span>
                    </div>
                    <button onclick="window.location.href='/dashboard'" class="text-sm text-gray-500 hover:text-gray-700 px-3 py-1 rounded-md border border-gray-300 hover:bg-gray-50">
                        <i class="fas fa-home mr-1"></i>
                        Dashboard
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Event Header -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-8">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between">
                <div class="mb-4 md:mb-0">
                    <h2 id="event-title" class="text-2xl font-bold text-gray-900 mb-2">Loading...</h2>
                    <p id="event-description" class="text-gray-600 mb-2">Loading...</p>
                    <div class="flex items-center space-x-4 text-sm text-gray-500">
                        <span>Code: <span id="event-code" class="font-mono bg-gray-100 px-2 py-1 rounded">Loading...</span></span>
                        <span id="event-status" class="px-2 py-1 rounded-full text-xs font-medium">Loading...</span>
                    </div>
                </div>
                <div class="flex flex-col space-y-2 md:text-right">
                    <div class="text-2xl font-bold text-green-600" id="total-contributions">$0.00</div>
                    <div class="text-sm text-gray-500">Total Pool</div>
                    <div class="text-lg font-semibold text-red-600" id="total-expenses">$0.00</div>
                    <div class="text-sm text-gray-500">Total Spent</div>
                    <div class="text-lg font-bold" id="remaining-balance">$0.00</div>
                    <div class="text-sm text-gray-500">Remaining</div>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
            <button onclick="showAddContributionModal()" class="bg-green-600 text-white py-3 px-4 rounded-lg hover:bg-green-700 transition duration-150 flex items-center justify-center">
                <i class="fas fa-plus-circle mr-2"></i>
                Add Contribution
            </button>
            <button onclick="showAddExpenseModal()" class="bg-blue-600 text-white py-3 px-4 rounded-lg hover:bg-blue-700 transition duration-150 flex items-center justify-center">
                <i class="fas fa-receipt mr-2"></i>
                Add Expense
            </button>
            <button onclick="showBalancesModal()" class="bg-purple-600 text-white py-3 px-4 rounded-lg hover:bg-purple-700 transition duration-150 flex items-center justify-center">
                <i class="fas fa-balance-scale mr-2"></i>
                View Balances
            </button>
            <button onclick="generateSettlements()" class="bg-orange-600 text-white py-3 px-4 rounded-lg hover:bg-orange-700 transition duration-150 flex items-center justify-center">
                <i class="fas fa-handshake mr-2"></i>
                Generate Settlements
            </button>
        </div>

        <!-- Tabs -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200">
            <div class="border-b border-gray-200">
                <nav class="-mb-px flex">
                    <button onclick="showTab('contributions')" class="tab-btn border-b-2 border-blue-500 text-blue-600 py-4 px-6 text-sm font-medium" data-tab="contributions">
                        <i class="fas fa-plus-circle mr-2"></i>Contributions
                    </button>
                    <button onclick="showTab('expenses')" class="tab-btn border-b-2 border-transparent text-gray-500 hover:text-gray-700 py-4 px-6 text-sm font-medium" data-tab="expenses">
                        <i class="fas fa-receipt mr-2"></i>Expenses
                    </button>
                    <button onclick="showTab('balances')" class="tab-btn border-b-2 border-transparent text-gray-500 hover:text-gray-700 py-4 px-6 text-sm font-medium" data-tab="balances">
                        <i class="fas fa-balance-scale mr-2"></i>Balances
                    </button>
                    <button onclick="showTab('settlements')" class="tab-btn border-b-2 border-transparent text-gray-500 hover:text-gray-700 py-4 px-6 text-sm font-medium" data-tab="settlements">
                        <i class="fas fa-handshake mr-2"></i>Settlements
                    </button>
                </nav>
            </div>

            <!-- Tab Content -->
            <div id="tab-content" class="p-6">
                <!-- Content will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-gray-50 bg-opacity-75 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 shadow-lg">
            <div class="flex items-center space-x-3">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                <span class="text-gray-700">Loading event details...</span>
            </div>
        </div>
    </div>

    <script>
        let currentEvent = null;
        let currentEventId = null;

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            const token = localStorage.getItem('token');
            const user = localStorage.getItem('user');

            if (!token || !user) {
                window.location.href = '/';
                return;
            }

            try {
                const userData = JSON.parse(user);
                document.getElementById('user-name').textContent = userData.username || userData.email;
            } catch (e) {
                console.error('Error parsing user data:', e);
                document.getElementById('user-name').textContent = 'User';
            }

            // Get event ID from URL
            const urlParams = new URLSearchParams(window.location.search);
            currentEventId = urlParams.get('id');
            
            if (!currentEventId) {
                alert('No event ID provided');
                window.location.href = '/dashboard';
                return;
            }

            loadEventDetails();
        });

        // Load event details
        async function loadEventDetails() {
            const token = localStorage.getItem('token');
            
            try {
                const response = await fetch(`/api/v1/events/${currentEventId}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    currentEvent = await response.json();
                    displayEventDetails(currentEvent);
                    showTab('contributions'); // Load default tab
                } else {
                    throw new Error('Failed to load event details');
                }
            } catch (error) {
                console.error('Error loading event:', error);
                alert('Failed to load event details');
                window.location.href = '/dashboard';
            } finally {
                document.getElementById('loading-overlay').style.display = 'none';
            }
        }

        // Display event details
        function displayEventDetails(event) {
            document.getElementById('event-name').textContent = event.name;
            document.getElementById('event-title').textContent = event.name;
            document.getElementById('event-description').textContent = event.description || 'No description';
            document.getElementById('event-code').textContent = event.code;
            
            const statusElement = document.getElementById('event-status');
            statusElement.textContent = event.status;
            statusElement.className = `px-2 py-1 rounded-full text-xs font-medium ${
                event.status === 'active' ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'
            }`;

            // Update financial summary
            const contributions = parseFloat(event.total_contributions || 0);
            const expenses = parseFloat(event.total_expenses || 0);
            const remaining = contributions - expenses;

            document.getElementById('total-contributions').textContent = `${event.currency} ${contributions.toFixed(2)}`;
            document.getElementById('total-expenses').textContent = `${event.currency} ${expenses.toFixed(2)}`;
            
            const remainingElement = document.getElementById('remaining-balance');
            remainingElement.textContent = `${event.currency} ${remaining.toFixed(2)}`;
            remainingElement.className = `text-lg font-bold ${remaining >= 0 ? 'text-green-600' : 'text-red-600'}`;
        }

        // Tab functionality
        function showTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.className = 'tab-btn border-b-2 border-transparent text-gray-500 hover:text-gray-700 py-4 px-6 text-sm font-medium';
            });
            document.querySelector(`[data-tab="${tabName}"]`).className = 'tab-btn border-b-2 border-blue-500 text-blue-600 py-4 px-6 text-sm font-medium';

            // Load tab content
            const contentDiv = document.getElementById('tab-content');
            
            switch(tabName) {
                case 'contributions':
                    loadContributionsTab(contentDiv);
                    break;
                case 'expenses':
                    loadExpensesTab(contentDiv);
                    break;
                case 'balances':
                    loadBalancesTab(contentDiv);
                    break;
                case 'settlements':
                    loadSettlementsTab(contentDiv);
                    break;
            }
        }

        // Load contributions tab
        async function loadContributionsTab(container) {
            container.innerHTML = '<div class="text-center py-8"><i class="fas fa-spinner fa-spin text-blue-600 text-2xl"></i><p class="mt-2 text-gray-600">Loading contributions...</p></div>';
            
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`/api/v1/events/${currentEventId}/summary`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    displayContributions(container, data.contributions || []);
                } else {
                    container.innerHTML = '<div class="text-center py-8 text-red-600"><i class="fas fa-exclamation-triangle"></i><p class="mt-2">Failed to load contributions</p></div>';
                }
            } catch (error) {
                container.innerHTML = '<div class="text-center py-8 text-red-600"><i class="fas fa-exclamation-triangle"></i><p class="mt-2">Error loading contributions</p></div>';
            }
        }

        // Display contributions
        function displayContributions(container, contributions) {
            if (!contributions || contributions.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12">
                        <i class="fas fa-plus-circle text-gray-400 text-4xl mb-4"></i>
                        <h3 class="text-lg font-medium text-gray-900 mb-2">No contributions yet</h3>
                        <p class="text-gray-500 mb-6">Start by adding your initial contribution to the event pool.</p>
                        <button onclick="showAddContributionModal()" class="bg-green-600 text-white py-2 px-4 rounded-lg hover:bg-green-700 transition">
                            <i class="fas fa-plus mr-2"></i>Add First Contribution
                        </button>
                    </div>
                `;
                return;
            }

            const contributionsHTML = `
                <div class="mb-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-medium text-gray-900">Contributions</h3>
                        <button onclick="showAddContributionModal()" class="bg-green-600 text-white py-2 px-4 rounded-lg hover:bg-green-700 transition text-sm">
                            <i class="fas fa-plus mr-2"></i>Add Contribution
                        </button>
                    </div>
                    <div class="space-y-3">
                        ${contributions.map(contribution => `
                            <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center space-x-3">
                                        <div class="h-10 w-10 bg-green-100 rounded-full flex items-center justify-center">
                                            <i class="fas fa-plus text-green-600"></i>
                                        </div>
                                        <div>
                                            <p class="font-medium text-gray-900">${contribution.user?.display_name || contribution.user?.username || 'Unknown User'}</p>
                                            <p class="text-sm text-gray-600">${new Date(contribution.timestamp).toLocaleDateString()}</p>
                                            ${contribution.notes ? `<p class="text-sm text-gray-600 mt-1">${contribution.notes}</p>` : ''}
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <p class="text-lg font-semibold text-green-600">+${contribution.currency} ${parseFloat(contribution.amount).toFixed(2)}</p>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;

            container.innerHTML = contributionsHTML;
        }

        // Load expenses tab
        async function loadExpensesTab(container) {
            container.innerHTML = '<div class="text-center py-8"><i class="fas fa-spinner fa-spin text-blue-600 text-2xl"></i><p class="mt-2 text-gray-600">Loading expenses...</p></div>';
            
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`/api/v1/expenses/event/${currentEventId}/`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const expenses = await response.json();
                    displayExpenses(container, expenses);
                } else {
                    container.innerHTML = '<div class="text-center py-8 text-red-600"><i class="fas fa-exclamation-triangle"></i><p class="mt-2">Failed to load expenses</p></div>';
                }
            } catch (error) {
                container.innerHTML = '<div class="text-center py-8 text-red-600"><i class="fas fa-exclamation-triangle"></i><p class="mt-2">Error loading expenses</p></div>';
            }
        }

        // Display expenses
        function displayExpenses(container, expenses) {
            if (!expenses || expenses.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12">
                        <i class="fas fa-receipt text-gray-400 text-4xl mb-4"></i>
                        <h3 class="text-lg font-medium text-gray-900 mb-2">No expenses yet</h3>
                        <p class="text-gray-500 mb-6">Record your first expense to start tracking group spending.</p>
                        <button onclick="showAddExpenseModal()" class="bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition">
                            <i class="fas fa-plus mr-2"></i>Add First Expense
                        </button>
                    </div>
                `;
                return;
            }

            const expensesHTML = `
                <div class="mb-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-medium text-gray-900">Expenses</h3>
                        <button onclick="showAddExpenseModal()" class="bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition text-sm">
                            <i class="fas fa-plus mr-2"></i>Add Expense
                        </button>
                    </div>
                    <div class="space-y-3">
                        ${expenses.map(expense => `
                            <div class="bg-white border border-gray-200 rounded-lg p-4">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center space-x-3">
                                        <div class="h-10 w-10 bg-blue-100 rounded-full flex items-center justify-center">
                                            <i class="fas fa-receipt text-blue-600"></i>
                                        </div>
                                        <div>
                                            <p class="font-medium text-gray-900">${expense.description}</p>
                                            <p class="text-sm text-gray-600">Paid by ${expense.submitter?.display_name || expense.submitter?.username || 'Unknown'}</p>
                                            <p class="text-sm text-gray-500">${new Date(expense.date).toLocaleDateString()}</p>
                                            ${expense.category?.name ? `<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-800 mt-1">${expense.category.icon || ''} ${expense.category.name}</span>` : ''}
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <p class="text-lg font-semibold text-gray-900">${expense.currency} ${parseFloat(expense.amount).toFixed(2)}</p>
                                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${
                                            expense.status === 'approved' ? 'bg-green-100 text-green-800' :
                                            expense.status === 'pending' ? 'bg-yellow-100 text-yellow-800' :
                                            'bg-red-100 text-red-800'
                                        }">${expense.status}</span>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;

            container.innerHTML = expensesHTML;
        }

        // Load balances tab
        async function loadBalancesTab(container) {
            container.innerHTML = '<div class="text-center py-8"><i class="fas fa-spinner fa-spin text-purple-600 text-2xl"></i><p class="mt-2 text-gray-600">Calculating balances...</p></div>';
            
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`/api/v1/settlements/event/${currentEventId}/balances`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const balances = await response.json();
                    displayBalances(container, balances);
                } else {
                    container.innerHTML = '<div class="text-center py-8 text-red-600"><i class="fas fa-exclamation-triangle"></i><p class="mt-2">Failed to load balances</p></div>';
                }
            } catch (error) {
                container.innerHTML = '<div class="text-center py-8 text-red-600"><i class="fas fa-exclamation-triangle"></i><p class="mt-2">Error loading balances</p></div>';
            }
        }

        // Display balances
        function displayBalances(container, balances) {
            if (!balances || balances.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12">
                        <i class="fas fa-balance-scale text-gray-400 text-4xl mb-4"></i>
                        <h3 class="text-lg font-medium text-gray-900 mb-2">No balance data</h3>
                        <p class="text-gray-500">Add contributions and expenses to see balance calculations.</p>
                    </div>
                `;
                return;
            }

            const balancesHTML = `
                <div class="mb-6">
                    <h3 class="text-lg font-medium text-gray-900 mb-4">Current Balances</h3>
                    <div class="space-y-3">
                        ${balances.map(balance => `
                            <div class="bg-white border border-gray-200 rounded-lg p-4">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center space-x-3">
                                        <div class="h-10 w-10 bg-purple-100 rounded-full flex items-center justify-center">
                                            <i class="fas fa-user text-purple-600"></i>
                                        </div>
                                        <div>
                                            <p class="font-medium text-gray-900">${balance.display_name || balance.username}</p>
                                            <p class="text-sm text-gray-600">Contributed: ${currentEvent.currency} ${parseFloat(balance.contributed || 0).toFixed(2)}</p>
                                            <p class="text-sm text-gray-600">Share of expenses: ${currentEvent.currency} ${parseFloat(balance.spent || 0).toFixed(2)}</p>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <p class="text-lg font-semibold ${parseFloat(balance.net_balance || 0) >= 0 ? 'text-green-600' : 'text-red-600'}">
                                            ${parseFloat(balance.net_balance || 0) >= 0 ? '+' : ''}${currentEvent.currency} ${parseFloat(balance.net_balance || 0).toFixed(2)}
                                        </p>
                                        <p class="text-sm text-gray-500">
                                            ${parseFloat(balance.net_balance || 0) >= 0 ? 'Is owed' : 'Owes'}
                                        </p>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;

            container.innerHTML = balancesHTML;
        }

        // Load settlements tab
        async function loadSettlementsTab(container) {
            container.innerHTML = '<div class="text-center py-8"><i class="fas fa-spinner fa-spin text-orange-600 text-2xl"></i><p class="mt-2 text-gray-600">Loading settlements...</p></div>';
            
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`/api/v1/settlements/event/${currentEventId}/`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const settlements = await response.json();
                    displaySettlements(container, settlements);
                } else {
                    container.innerHTML = '<div class="text-center py-8 text-red-600"><i class="fas fa-exclamation-triangle"></i><p class="mt-2">Failed to load settlements</p></div>';
                }
            } catch (error) {
                container.innerHTML = '<div class="text-center py-8 text-red-600"><i class="fas fa-exclamation-triangle"></i><p class="mt-2">Error loading settlements</p></div>';
            }
        }

        // Display settlements
        function displaySettlements(container, settlements) {
            if (!settlements || settlements.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12">
                        <i class="fas fa-handshake text-gray-400 text-4xl mb-4"></i>
                        <h3 class="text-lg font-medium text-gray-900 mb-2">No settlements generated</h3>
                        <p class="text-gray-500 mb-6">Generate optimal settlements to see who should pay whom.</p>
                        <button onclick="generateSettlements()" class="bg-orange-600 text-white py-2 px-4 rounded-lg hover:bg-orange-700 transition">
                            <i class="fas fa-calculator mr-2"></i>Generate Settlements
                        </button>
                    </div>
                `;
                return;
            }

            const settlementsHTML = `
                <div class="mb-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-medium text-gray-900">Settlement Transactions</h3>
                        <button onclick="generateSettlements()" class="bg-orange-600 text-white py-2 px-4 rounded-lg hover:bg-orange-700 transition text-sm">
                            <i class="fas fa-refresh mr-2"></i>Regenerate
                        </button>
                    </div>
                    <div class="space-y-3">
                        ${settlements.map(settlement => `
                            <div class="bg-orange-50 border border-orange-200 rounded-lg p-4">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center space-x-3">
                                        <div class="h-10 w-10 bg-orange-100 rounded-full flex items-center justify-center">
                                            <i class="fas fa-arrow-right text-orange-600"></i>
                                        </div>
                                        <div>
                                            <p class="font-medium text-gray-900">
                                                <span class="text-red-600">${settlement.from_user?.display_name || settlement.from_user?.username}</span>
                                                <i class="fas fa-arrow-right mx-2 text-gray-400"></i>
                                                <span class="text-green-600">${settlement.to_user?.display_name || settlement.to_user?.username}</span>
                                            </p>
                                            <p class="text-sm text-gray-600">${settlement.method || 'Payment method not specified'}</p>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <p class="text-lg font-semibold text-gray-900">${settlement.currency} ${parseFloat(settlement.amount).toFixed(2)}</p>
                                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${
                                            settlement.status === 'completed' ? 'bg-green-100 text-green-800' :
                                            settlement.status === 'pending' ? 'bg-yellow-100 text-yellow-800' :
                                            'bg-red-100 text-red-800'
                                        }">${settlement.status}</span>
                                        ${settlement.status === 'pending' ? `
                                            <button onclick="markSettlementCompleted(${settlement.id})" class="block mt-2 text-xs bg-green-600 text-white px-2 py-1 rounded hover:bg-green-700">
                                                Mark Paid
                                            </button>
                                        ` : ''}
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;

            container.innerHTML = settlementsHTML;
        }

        // Show Add Contribution Modal
        function showAddContributionModal() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50';
            modal.innerHTML = `
                <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
                    <div class="mt-3">
                        <h3 class="text-lg font-medium text-gray-900 mb-4">Add Contribution</h3>
                        <form id="add-contribution-form">
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Amount (${currentEvent.currency})</label>
                                <input type="number" id="contribution-amount" required step="0.01" min="0.01"
                                       class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-500"
                                       placeholder="Enter amount">
                            </div>
                            <div class="mb-6">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Notes (Optional)</label>
                                <textarea id="contribution-notes" rows="3"
                                          class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-500"
                                          placeholder="Optional notes about this contribution"></textarea>
                            </div>
                            <div class="flex space-x-3">
                                <button type="button" onclick="closeModal()" 
                                        class="w-full bg-gray-300 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-400 transition">
                                    Cancel
                                </button>
                                <button type="submit" 
                                        class="w-full bg-green-600 text-white py-2 px-4 rounded-lg hover:bg-green-700 transition">
                                    Add Contribution
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            document.getElementById('add-contribution-form').addEventListener('submit', handleAddContribution);
        }

        // Handle Add Contribution
        async function handleAddContribution(e) {
            e.preventDefault();
            
            const token = localStorage.getItem('token');
            const contributionData = {
                amount: document.getElementById('contribution-amount').value,
                currency: currentEvent.currency,
                notes: document.getElementById('contribution-notes').value
            };

            try {
                const response = await fetch(`/api/v1/events/${currentEventId}/contributions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(contributionData)
                });

                if (response.ok) {
                    closeModal();
                    showToast('Contribution added successfully!', 'success');
                    loadEventDetails(); // Refresh event details
                    showTab('contributions'); // Refresh contributions tab
                } else {
                    const data = await response.json();
                    alert('Error adding contribution: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                alert('Error adding contribution: ' + error.message);
            }
        }

        // Show Add Expense Modal
        async function showAddExpenseModal() {
            // First load categories
            const token = localStorage.getItem('token');
            let categoriesOptions = '';
            
            try {
                const response = await fetch('/api/v1/categories', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const categories = await response.json();
                    categoriesOptions = categories.map(cat => 
                        `<option value="${cat.id}">${cat.icon || ''} ${cat.name}</option>`
                    ).join('');
                }
            } catch (error) {
                console.error('Error loading categories:', error);
            }

            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50';
            modal.innerHTML = `
                <div class="relative top-10 mx-auto p-5 border w-11/12 max-w-2xl shadow-lg rounded-md bg-white">
                    <div class="mt-3">
                        <h3 class="text-lg font-medium text-gray-900 mb-4">Add Expense</h3>
                        <form id="add-expense-form">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Description *</label>
                                    <input type="text" id="expense-description" required
                                           class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                                           placeholder="What was this expense for?">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Amount (${currentEvent.currency}) *</label>
                                    <input type="number" id="expense-amount" required step="0.01" min="0.01"
                                           class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                                           placeholder="Enter amount">
                                </div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Category *</label>
                                    <select id="expense-category" required
                                            class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <option value="">Select category</option>
                                        ${categoriesOptions}
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Date *</label>
                                    <input type="date" id="expense-date" required
                                           class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Location</label>
                                    <input type="text" id="expense-location"
                                           class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                                           placeholder="Where was this expense?">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Vendor</label>
                                    <input type="text" id="expense-vendor"
                                           class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                                           placeholder="Store, restaurant, etc.">
                                </div>
                            </div>
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Split Type</label>
                                <select id="expense-split-type"
                                        class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="equal">Equal split among all participants</option>
                                    <option value="percentage">Percentage split</option>
                                    <option value="custom">Custom amounts</option>
                                </select>
                            </div>
                            <div class="mb-6">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Notes</label>
                                <textarea id="expense-notes" rows="3"
                                          class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                                          placeholder="Optional notes about this expense"></textarea>
                            </div>
                            <div class="flex space-x-3">
                                <button type="button" onclick="closeModal()" 
                                        class="w-full bg-gray-300 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-400 transition">
                                    Cancel
                                </button>
                                <button type="submit" 
                                        class="w-full bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition">
                                    Add Expense
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Set today as default date
            document.getElementById('expense-date').valueAsDate = new Date();
            
            document.getElementById('add-expense-form').addEventListener('submit', handleAddExpense);
        }

        // Handle Add Expense
        async function handleAddExpense(e) {
            e.preventDefault();
            
            const token = localStorage.getItem('token');
            const expenseData = {
                description: document.getElementById('expense-description').value,
                amount: document.getElementById('expense-amount').value,
                currency: currentEvent.currency,
                category_id: parseInt(document.getElementById('expense-category').value),
                date: document.getElementById('expense-date').value + 'T00:00:00Z',
                location: document.getElementById('expense-location').value,
                vendor: document.getElementById('expense-vendor').value,
                split_type: document.getElementById('expense-split-type').value,
                notes: document.getElementById('expense-notes').value,
                participants: [] // For now, using equal split among all participants
            };

            try {
                const response = await fetch(`/api/v1/expenses/event/${currentEventId}/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(expenseData)
                });

                if (response.ok) {
                    closeModal();
                    showToast('Expense added successfully!', 'success');
                    loadEventDetails(); // Refresh event details
                    showTab('expenses'); // Refresh expenses tab
                } else {
                    const data = await response.json();
                    alert('Error adding expense: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                alert('Error adding expense: ' + error.message);
            }
        }

        // Generate Settlements
        async function generateSettlements() {
            const token = localStorage.getItem('token');
            
            try {
                const response = await fetch(`/api/v1/settlements/event/${currentEventId}/generate`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    showToast('Settlements generated successfully!', 'success');
                    showTab('settlements'); // Refresh settlements tab
                } else {
                    const data = await response.json();
                    alert('Error generating settlements: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                alert('Error generating settlements: ' + error.message);
            }
        }

        // Mark Settlement Completed
        async function markSettlementCompleted(settlementId) {
            const token = localStorage.getItem('token');
            
            try {
                const response = await fetch(`/api/v1/settlements/${settlementId}/complete`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    showToast('Settlement marked as completed!', 'success');
                    showTab('settlements'); // Refresh settlements tab
                } else {
                    const data = await response.json();
                    alert('Error completing settlement: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                alert('Error completing settlement: ' + error.message);
            }
        }

        // Show Balances Modal
        function showBalancesModal() {
            showTab('balances');
        }

        // Utility functions
        function closeModal() {
            const modal = document.querySelector('.fixed.inset-0.bg-gray-600');
            if (modal) {
                modal.remove();
            }
        }

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            const bgColor = type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500';
            const icon = type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-triangle' : 'fa-info-circle';
            
            toast.className = `fixed top-4 right-4 ${bgColor} text-white px-6 py-3 rounded-lg shadow-lg z-50`;
            toast.innerHTML = `<i class="fas ${icon} mr-2"></i>${message}`;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 5000);
        }
    </script>
</body>
</html>
