<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{.title}}</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <h1 class="text-3xl font-bold mb-8 text-center">Event Details</h1>
        
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
            <button onclick="showAddContributionModal()" class="bg-green-600 text-white py-3 px-4 rounded-lg hover:bg-green-700 transition duration-150 flex items-center justify-center">
                <i class="fas fa-plus-circle mr-2"></i> Add Contribution
            </button>
            <button onclick="showAddExpenseModal()" class="bg-blue-600 text-white py-3 px-4 rounded-lg hover:bg-blue-700 transition duration-150 flex items-center justify-center">
                <i class="fas fa-receipt mr-2"></i> Add Expense
            </button>
            <button onclick="viewBalances()" class="bg-purple-600 text-white py-3 px-4 rounded-lg hover:bg-purple-700 transition duration-150 flex items-center justify-center">
                <i class="fas fa-balance-scale mr-2"></i> View Balances
            </button>
            <button onclick="generateSettlements()" class="bg-orange-600 text-white py-3 px-4 rounded-lg hover:bg-orange-700 transition duration-150 flex items-center justify-center">
                <i class="fas fa-handshake mr-2"></i> Generate Settlements
            </button>
        </div>

        <div id="content" class="bg-white rounded-lg shadow p-6">
            <p class="text-center text-gray-600">Select an action above to get started with expense tracking.</p>
        </div>
    </div>

    <script>
        const currentEventId = new URLSearchParams(window.location.search).get('id') || '1';
        let currentUserRole = null;
        
        // Get current user's role in this event
        async function getCurrentUserRole() {
            try {
                const response = await fetch(`/api/v1/events/${currentEventId}`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                
                if (response.ok) {
                    const eventData = await response.json();
                    currentUserRole = eventData.user_role || 'participant';
                    console.log('User role loaded:', currentUserRole);
                } else {
                    console.error('Failed to fetch user role, response:', response.status);
                    currentUserRole = 'participant';
                }
            } catch (error) {
                console.error('Failed to get user role:', error);
                currentUserRole = 'participant';
            }
        }
        
        // Initialize user role on page load
        getCurrentUserRole();
        
        // Debug function - you can call this in browser console: debugExpenseApproval()
        window.debugExpenseApproval = function() {
            console.log('=== EXPENSE APPROVAL DEBUG ===');
            console.log('Current Event ID:', currentEventId);
            console.log('Current User Role:', currentUserRole);
            console.log('Token exists:', !!localStorage.getItem('token'));
            
            // Test API call
            fetch(`/api/v1/events/${currentEventId}`, {
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('token')}`
                }
            })
            .then(response => response.json())
            .then(data => {
                console.log('API Response:', data);
                console.log('User role from API:', data.user_role);
            })
            .catch(error => {
                console.error('API Error:', error);
            });
        };
        
        function showAddContributionModal() {
            document.getElementById('content').innerHTML = `
                <h2 class="text-2xl font-bold mb-4">Add Contribution</h2>
                <form onsubmit="addContribution(event)" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Amount</label>
                        <input type="number" id="contribution-amount" step="0.01" min="0.01" required 
                               class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Notes</label>
                        <textarea id="contribution-notes" rows="3" 
                                  class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-500"></textarea>
                    </div>
                    <button type="submit" class="w-full bg-green-600 text-white py-2 px-4 rounded-lg hover:bg-green-700">
                        Add Contribution
                    </button>
                </form>
            `;
        }

        function showAddExpenseModal() {
            document.getElementById('content').innerHTML = `
                <h2 class="text-2xl font-bold mb-4">Add Expense</h2>
                <form onsubmit="addExpense(event)" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                        <input type="text" id="expense-description" required 
                               class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Amount</label>
                        <input type="number" id="expense-amount" step="0.01" min="0.01" required 
                               class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Category</label>
                        <select id="expense-category" required 
                                class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">Select category</option>
                            <option value="1">üçΩÔ∏è Food & Dining</option>
                            <option value="2">üöó Transportation</option>
                            <option value="3">üè® Accommodation</option>
                            <option value="4">üé¨ Entertainment</option>
                            <option value="5">üõçÔ∏è Shopping</option>
                        </select>
                    </div>
                    <button type="submit" class="w-full bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700">
                        Add Expense
                    </button>
                </form>
            `;
        }

        async function addContribution(event) {
            event.preventDefault();
            const amount = document.getElementById('contribution-amount').value;
            const notes = document.getElementById('contribution-notes').value;
            
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`/api/v1/events/${currentEventId}/contributions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + token
                    },
                    body: JSON.stringify({
                        amount: amount,
                        currency: 'USD',
                        notes: notes
                    })
                });

                if (response.ok) {
                    alert('Contribution added successfully!');
                    showSuccess('Contribution added successfully!');
                } else {
                    const data = await response.json();
                    alert('Error: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        async function addExpense(event) {
            event.preventDefault();
            const description = document.getElementById('expense-description').value;
            const amount = document.getElementById('expense-amount').value;
            const categoryId = document.getElementById('expense-category').value;
            
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`/api/v1/expenses/event/${currentEventId}/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + token
                    },
                    body: JSON.stringify({
                        description: description,
                        amount: amount,
                        currency: 'USD',
                        category_id: parseInt(categoryId),
                        date: new Date().toISOString().split('T')[0] + 'T00:00:00Z',
                        split_type: 'equal',
                        participants: []
                    })
                });

                if (response.ok) {
                    showSuccess('Expense added successfully!');
                } else {
                    const data = await response.json();
                    alert('Error: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        async function viewBalances() {
            document.getElementById('content').innerHTML = '<div class="text-center py-8"><i class="fas fa-spinner fa-spin text-2xl"></i><p class="mt-2">Loading balances and expenses...</p></div>';
            
            try {
                const token = localStorage.getItem('token');
                
                // Fetch both balances and expenses
                const [balancesResponse, expensesResponse] = await Promise.all([
                    fetch(`/api/v1/settlements/event/${currentEventId}/balances`, {
                        headers: { 'Authorization': 'Bearer ' + token }
                    }),
                    fetch(`/api/v1/expenses/event/${currentEventId}/`, {
                        headers: { 'Authorization': 'Bearer ' + token }
                    })
                ]);

                if (balancesResponse.ok && expensesResponse.ok) {
                    const balances = await balancesResponse.json();
                    const expenses = await expensesResponse.json();
                    
                    let html = '<div class="grid grid-cols-1 lg:grid-cols-2 gap-6">';
                    
                    // Balances section
                    html += '<div><h2 class="text-2xl font-bold mb-4">Current Balances</h2>';
                    if (balances.length === 0) {
                        html += '<p class="text-gray-600">No balance data available yet.</p>';
                    } else {
                        html += '<div class="space-y-3">';
                        balances.forEach(balance => {
                            const netBalance = parseFloat(balance.net_balance || 0);
                            html += `<div class="border rounded-lg p-4 flex justify-between items-center">
                                <div>
                                    <p class="font-medium">${balance.display_name || balance.username}</p>
                                    <p class="text-sm text-gray-600">Contributed: $${parseFloat(balance.contributed || 0).toFixed(2)} | Spent: $${parseFloat(balance.spent || 0).toFixed(2)}</p>
                                </div>
                                <div class="text-lg font-semibold ${netBalance >= 0 ? 'text-green-600' : 'text-red-600'}">
                                    ${netBalance >= 0 ? '+' : ''}$${netBalance.toFixed(2)}
                                </div>
                            </div>`;
                        });
                        html += '</div>';
                    }
                    html += '</div>';
                    
                    // Expenses section
                    html += '<div><h2 class="text-2xl font-bold mb-4">All Expenses</h2>';
                    if (expenses.length === 0) {
                        html += '<p class="text-gray-600">No expenses yet.</p>';
                    } else {
                        html += '<div class="space-y-3">';
                        expenses.forEach(expense => {
                            const statusColor = expense.status === 'approved' ? 'text-green-600' : 
                                              expense.status === 'rejected' ? 'text-red-600' : 'text-yellow-600';
                            const statusBg = expense.status === 'approved' ? 'bg-green-100' : 
                                           expense.status === 'rejected' ? 'bg-red-100' : 'bg-yellow-100';
                            
                            html += `<div class="border rounded-lg p-4 hover:bg-gray-50 cursor-pointer" onclick="showExpenseDetails(${expense.id})">
                                <div class="flex justify-between items-center">
                                    <div>
                                        <p class="font-medium">${expense.description}</p>
                                        <p class="text-sm text-gray-600">by ${expense.submitter?.username || 'Unknown'} ‚Ä¢ ${new Date(expense.date).toLocaleDateString()}</p>
                                    </div>
                                    <div class="text-right">
                                        <p class="text-lg font-semibold">$${parseFloat(expense.amount).toFixed(2)}</p>
                                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${statusBg} ${statusColor}">
                                            ${expense.status}
                                        </span>
                                    </div>
                                </div>
                            </div>`;
                        });
                        html += '</div>';
                    }
                    html += '</div></div>';
                    
                    document.getElementById('content').innerHTML = html;
                } else {
                    document.getElementById('content').innerHTML = '<p class="text-center text-red-600 py-8">Failed to load balances</p>';
                }
            } catch (error) {
                console.error('Error fetching balances:', error);
                document.getElementById('content').innerHTML = '<p class="text-center text-red-600 py-8">Error loading balances</p>';
            }
        }

        // Add debug button to test function directly
        window.testSettlementGeneration = function() {
            console.log('üß™ TESTING: Manual function call');
            generateSettlements();
        };

        async function generateSettlements() {
            console.log('DEBUG: generateSettlements called from template');
            console.log('DEBUG: currentEventId =', currentEventId);
            console.log('DEBUG: token =', localStorage.getItem('token') ? 'exists' : 'missing');
            
            document.getElementById('content').innerHTML = '<div class="text-center py-8"><i class="fas fa-spinner fa-spin text-2xl"></i><p class="mt-2">Generating settlements...</p></div>';
            
            try {
                const token = localStorage.getItem('token');
                const url = `/api/v1/settlements/event/${currentEventId}/generate`;
                console.log('DEBUG: Making request to:', url);
                
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Authorization': 'Bearer ' + token }
                });

                console.log('DEBUG: Response status:', response.status);
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('DEBUG: Success response:', result);
                    showSuccess('Settlements generated successfully!');
                    setTimeout(() => viewSettlements(), 1000);
                } else {
                    const data = await response.json();
                    console.log('DEBUG: Error response:', data);
                    alert('Error: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('DEBUG: Exception caught:', error);
                alert('Error: ' + error.message);
            }
        }

        async function viewSettlements() {
            try {
                const token = localStorage.getItem('token');
                const url = `/api/v1/settlements/event/${currentEventId}/`;
                console.log('DEBUG: Fetching settlements from:', url);
                
                const response = await fetch(url, {
                    headers: { 'Authorization': 'Bearer ' + token }
                });

                console.log('DEBUG: viewSettlements response status:', response.status);
                
                if (response.ok) {
                    const settlements = await response.json();
                    console.log('DEBUG: Retrieved settlements:', settlements);
                    console.log('DEBUG: Settlements count:', settlements.length);
                    
                    let html = '<h2 class="text-2xl font-bold mb-4">Settlements</h2>';
                    if (settlements.length === 0) {
                        html += '<p class="text-gray-600">No settlements generated yet.</p>';
                    } else {
                        html += '<div class="space-y-3">';
                        settlements.forEach(settlement => {
                            html += `<div class="border rounded-lg p-4">
                                <div class="flex justify-between items-center">
                                    <div>
                                        <p class="font-medium">
                                            <span class="text-red-600">${settlement.from_user?.display_name || settlement.from_user?.username}</span>
                                            <i class="fas fa-arrow-right mx-2"></i>
                                            <span class="text-green-600">${settlement.to_user?.display_name || settlement.to_user?.username}</span>
                                        </p>
                                        <p class="text-sm text-gray-600">${settlement.status}</p>
                                    </div>
                                    <div class="text-lg font-semibold">$${parseFloat(settlement.amount).toFixed(2)}</div>
                                </div>
                            </div>`;
                        });
                        html += '</div>';
                    }
                    document.getElementById('content').innerHTML = html;
                } else {
                    console.log('DEBUG: viewSettlements failed with status:', response.status);
                    const errorData = await response.json();
                    console.log('DEBUG: viewSettlements error response:', errorData);
                    document.getElementById('content').innerHTML = '<p class="text-red-600">Error loading settlements</p>';
                }
            } catch (error) {
                console.error('DEBUG: viewSettlements exception:', error);
                document.getElementById('content').innerHTML = '<p class="text-red-600">Error loading settlements</p>';
            }
        }

        function showSuccess(message) {
            document.getElementById('content').innerHTML = `
                <div class="text-center py-12">
                    <i class="fas fa-check-circle text-green-500 text-6xl mb-4"></i>
                    <h2 class="text-2xl font-bold text-gray-900 mb-2">Success!</h2>
                    <p class="text-gray-600">${message}</p>
                </div>
            `;
        }
    </script>
    <script src="/static/js/utils.js"></script>
    <script src="/static/js/expense-features.js"></script>
</body>
</html>
